#!/usr/bin/env ruby
require_relative '../lib/bill-nye/version'
require_relative '../lib/bill-nye/bnlogger'
require_relative '../lib/bill-nye'
require 'micro-optparse'
require 'yajl'

module BillNye

  # define what a valid Config file argument is
  def self.validConfigArgument?(x)
    #must explicitly get set to 'true'
    answer = false

    begin
      # must successfully open file, and deserialize into a ruby hash
      json = File.read(x)
      parser = Yajl::Parser.new
      @config = parser.parse json

      # TODO: add additional json requirements here, if needed
      #
      # TODO <end>

      # if we made it this far, we're valid
      answer = true
    rescue => e
      # if we fail to open, parse, etc...this is not a valid configArgument
      puts e
      return false
    end

    return answer

  end

  options = Parser.new do |p|
    p.banner = "This is the Media Requester"
    p.version = "media-requester" + VERSION
    #p.option :config, "config file (valid json)", :default => 'config.json', :value_satisfies => lambda {|x| validConfigArgument?(x) }
  end.process!

  BNLogger.configure
  BNLogger.log.info { "Started." }

  processor = BillNye.new#(@config, options[:retry])
  
  Dir.foreach('/Users/keeninvye/playground/dev/ruby/BillNye/pdf/') do |pdf|
    if not pdf =~ /^\.\.?$/ 
      if pdf.include? ".pdf"
        p pdf
        _match    = /(?<filename>.+).pdf/.match(pdf)
        p _match
        txt     = "#{_match[:filename]}.txt"

        begin
          if txt.include? "credit"
            _xaction_list = processor.parse_pdf("pdf/#{pdf}", 2)
          else
            _xaction_list = processor.parse_pdf("pdf/#{pdf}", 1)
          end
          _xaction_list.each do |item|
            File.open(txt, "w") do |file|
              file.write(item)
            end
          end
        rescue
          p "Failed to convert #{pdf} to text."
        end
      end
    end
  end

  #x = processor.parse_pdf('pdf/2017-05-10-credit-6042.pdf', 2)
  #p x.length
  #Logger.log.info { "Exited normally." }

end
